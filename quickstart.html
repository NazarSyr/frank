



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Performing a fit &mdash; frank 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorials" href="tutorials.html" />
    <link rel="prev" title="Installation" href="install.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> frank
          

          
            
            <img src="_static/prom_photo.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Using the code</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html"> Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#"> Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#perform-a-fit-from-the-terminal">Perform a fit from the terminal</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-a-fit-s-convergence">Test a fit’s convergence</a></li>
<li class="toctree-l3"><a class="reference internal" href="#perform-multiple-fits-in-a-loop">Perform multiple fits in a loop</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modify-the-fit-py-script">Modify the <code class="code docutils literal notranslate"><span class="pre">fit.py</span></code> script</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#perform-a-fit-using-frank-as-a-python-module">Perform a fit using <code class="code docutils literal notranslate"><span class="pre">frank</span></code> as a Python module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html"> Tutorials</a></li>
<li class="toctree-l1"><a class="reference external" href="https://ui.adsabs.harvard.edu/public-libraries/xx"> Papers using frank</a></li>
</ul>
<p class="caption"><span class="caption-text">Under the hood</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="py_API.html"> API</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html"> Index</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/discsim/frank"> Github</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/discsim/frank/issues"> Submit an issue</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">frank</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Performing a fit</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="performing-a-fit">
<h1>Performing a fit<a class="headerlink" href="#performing-a-fit" title="Permalink to this headline">¶</a></h1>
<p>You can interface with Frankenstein (<code class="docutils literal notranslate"><span class="pre">frank</span></code>) to perform a fit in 2 ways:
<strong>(1)</strong> run the code directly from the terminal or <strong>(2)</strong> use the code as a Python module.</p>
<div class="section" id="perform-a-fit-from-the-terminal">
<h2>Perform a fit from the terminal<a class="headerlink" href="#perform-a-fit-from-the-terminal" title="Permalink to this headline">¶</a></h2>
<p>To perform a quick fit from the terminal, only a UVTable with the data to
be fit and a <em>.json</em> parameter file (see below) are needed. A UVTable can be extracted
with CASA as demonstrated in <a class="reference external" href="tutorials/xx">this tutorial</a>.
The column format should be <code class="code docutils literal notranslate"><span class="pre">u</span> <span class="pre">[m]</span>&#160;&#160;&#160;&#160; <span class="pre">v</span> <span class="pre">[m]</span>&#160;&#160;&#160;&#160;&#160; <span class="pre">Re(V)</span> <span class="pre">[Jy]</span>&#160;&#160;&#160;&#160; <span class="pre">Im(V)</span> <span class="pre">[Jy]</span>&#160;&#160;&#160;&#160; <span class="pre">Weight</span> <span class="pre">[Jy^-2]</span></code>.</p>
<p>You can quickly run a fit with the default parameter file, <code class="code docutils literal notranslate"><span class="pre">default_parameters.json</span></code> (see below),
by just passing in the filename of the UVTable to be fit with the <code class="code docutils literal notranslate"><span class="pre">-uv</span></code> option. The UVTable can be a <code class="code docutils literal notranslate"><span class="pre">.npz</span></code>, <code class="code docutils literal notranslate"><span class="pre">.txt</span></code> or <code class="code docutils literal notranslate"><span class="pre">.dat</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m frank.fit -uv &lt;uvtable_filename.npz&gt;
</pre></div>
</div>
<p>If you want to change the default parameters, provide a custom parameter file with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m frank.fit <span class="o">[</span>-uv uvtable_filename.npz<span class="o">]</span> -p &lt;parameter_filename.json&gt;
</pre></div>
</div>
<p>The default parameter file is <code class="docutils literal notranslate"><span class="pre">default_parameters.json</span></code>. You can get it
<a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/default_parameters.json">here</a>,
and it looks like this,</p>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input_output&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;uvtable_filename&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_dir&quot;</span>         <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_solution&quot;</span>    <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;save_profile_fit&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;save_vis_fit&quot;</span>     <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;save_uvtables&quot;</span>    <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;iteration_diag&quot;</span>   <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;format&quot;</span>           <span class="p">:</span> <span class="kc">null</span>
  <span class="p">},</span>

  <span class="nt">&quot;modify_data&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;baseline_range&quot;</span>   <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&quot;correct_weights&quot;</span>  <span class="p">:</span> <span class="kc">false</span>
  <span class="p">},</span>

  <span class="nt">&quot;geometry&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span>             <span class="p">:</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fit_phase_offset&quot;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;inc&quot;</span>              <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nt">&quot;pa&quot;</span>               <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nt">&quot;dra&quot;</span>              <span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nt">&quot;ddec&quot;</span>             <span class="p">:</span> <span class="mf">0.0</span>
  <span class="p">},</span>

  <span class="nt">&quot;hyperpriors&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;n&quot;</span>                <span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
    <span class="nt">&quot;rout&quot;</span>             <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="nt">&quot;alpha&quot;</span>            <span class="p">:</span> <span class="mf">1.05</span><span class="p">,</span>
    <span class="nt">&quot;p0&quot;</span>               <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
    <span class="nt">&quot;wsmooth&quot;</span>          <span class="p">:</span> <span class="mf">1e-4</span><span class="p">,</span>
    <span class="nt">&quot;iter_tol&quot;</span>         <span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span>
    <span class="nt">&quot;max_iter&quot;</span>         <span class="p">:</span> <span class="mi">2000</span>
  <span class="p">},</span>

  <span class="nt">&quot;plotting&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;quick_plot&quot;</span>       <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;full_plot&quot;</span>        <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;diag_plot&quot;</span>        <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;save_figs&quot;</span>        <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;dist&quot;</span>             <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&quot;force_style&quot;</span>      <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;bin_widths&quot;</span>       <span class="p">:</span> <span class="p">[</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">5e4</span><span class="p">],</span>
    <span class="nt">&quot;iter_plot_range&quot;</span>  <span class="p">:</span> <span class="kc">null</span>
  <span class="p">},</span>

  <span class="nt">&quot;analysis&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;bootstrap_ntrials&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nt">&quot;bootstrap_non_negative&quot;</span> <span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Note that anytime you run a fit without specifying <code class="code docutils literal notranslate"><span class="pre">-p</span></code>, frank’s internal <code class="code docutils literal notranslate"><span class="pre">default_parameters.json</span></code> will be used.</p>
<p>You can get a description for each parameter with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -c <span class="s1">&#39;import frank.fit; frank.fit.helper()&#39;</span>
</pre></div>
</div>
<p>which returns</p>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;input_output&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;uvtable_filename&quot;</span> <span class="p">:</span> <span class="s2">&quot;UVTable with data to be fit (columns: u, v, Re(V), Im(V), weights)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_dir&quot;</span>         <span class="p">:</span> <span class="s2">&quot;Directory in which output datafiles and figures are saved&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_solution&quot;</span>    <span class="p">:</span> <span class="s2">&quot;Whether to save `sol` object (see frank.radial_fitters.FrankFitter)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_profile_fit&quot;</span> <span class="p">:</span> <span class="s2">&quot;Whether to save fitted brightness profile&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_vis_fit&quot;</span>     <span class="p">:</span> <span class="s2">&quot;Whether to save fitted visibility distribution&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_uvtables&quot;</span>    <span class="p">:</span> <span class="s2">&quot;Whether to save fitted and residual UV tables (these are reprojected)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;iteration_diag&quot;</span>   <span class="p">:</span> <span class="s2">&quot;Whether to return diagnostics of the fit iteration (needed for diag_plot)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;format&quot;</span>           <span class="p">:</span> <span class="s2">&quot;Output file format. Default is the same as for &#39;uvtable_filename&#39;, else choose from &#39;npz&#39; or &#39;txt&#39;&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;modify_data&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;baseline_range&quot;</span>   <span class="p">:</span> <span class="s2">&quot;Baseline range outside of which visibilities are truncated [\\lambda]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;correct_weights&quot;</span>  <span class="p">:</span> <span class="s2">&quot;Whether to estimate the data&#39;s weights (as they may be unknown for mock data)&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;geometry&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span>             <span class="p">:</span> <span class="s2">&quot;How the geometry is determined: &#39;known&#39; if user-supplied, &#39;gaussian&#39; if it is to be fit&quot;</span><span class="p">,</span>
    <span class="nt">&quot;fit_phase_offset&quot;</span> <span class="p">:</span> <span class="s2">&quot;Whether to fit for the phase center or just the inclination and position angle&quot;</span><span class="p">,</span>
    <span class="nt">&quot;inc&quot;</span>              <span class="p">:</span> <span class="s2">&quot;Inclination [deg]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;pa&quot;</span>               <span class="p">:</span> <span class="s2">&quot;Position angle [deg]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dra&quot;</span>              <span class="p">:</span> <span class="s2">&quot;Delta (offset from 0) right ascension [arcsec]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ddec&quot;</span>             <span class="p">:</span> <span class="s2">&quot;Delta declination [arcsec]&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;hyperpriors&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;n&quot;</span>                <span class="p">:</span> <span class="s2">&quot;Number of collocation points used in the fit (suggested range 100 - 300)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rout&quot;</span>             <span class="p">:</span> <span class="s2">&quot;Maximum disc radius in the fit (best to overestimate size of source) [arcsec]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;alpha&quot;</span>            <span class="p">:</span> <span class="s2">&quot;Order parameter for the power spectrum&#39;s inverse Gamma prior (suggested range 1.00 - 1.50)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;p0&quot;</span>               <span class="p">:</span> <span class="s2">&quot;Scale parameter for the power spectrum&#39;s inverse Gamma prior (suggested &gt;0, &lt;&lt;1)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;wsmooth&quot;</span>          <span class="p">:</span> <span class="s2">&quot;Strength of smoothing applied to the power spectrum (suggested range 10^-4 - 10^-1)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;iter_tol&quot;</span>         <span class="p">:</span> <span class="s2">&quot;Tolerance for fit iteration stopping criterion (suggested &lt;&lt;1)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;max_iter&quot;</span>         <span class="p">:</span> <span class="s2">&quot;Maximum number of fit iterations&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;plotting&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;quick_plot&quot;</span>       <span class="p">:</span> <span class="s2">&quot;Whether to make a figure showing the simplest plots of the fit&quot;</span><span class="p">,</span>
    <span class="nt">&quot;full_plot&quot;</span>        <span class="p">:</span> <span class="s2">&quot;Whether to make a figure more fully showing the fit and its diagnostics&quot;</span><span class="p">,</span>
    <span class="nt">&quot;diag_plot&quot;</span>        <span class="p">:</span> <span class="s2">&quot;Whether to make a diagnostic figure showing fit convergence metrics&quot;</span><span class="p">,</span>
    <span class="nt">&quot;save_figs&quot;</span>        <span class="p">:</span> <span class="s2">&quot;Whether to save generated figures&quot;</span><span class="p">,</span>
    <span class="nt">&quot;dist&quot;</span>             <span class="p">:</span> <span class="s2">&quot;Distance to source, optionally used for plotting [AU]&quot;</span><span class="p">,</span>
    <span class="nt">&quot;force_style&quot;</span>      <span class="p">:</span> <span class="s2">&quot;Whether to use preconfigured matplotlib rcParams in generated figures&quot;</span><span class="p">,</span>
    <span class="nt">&quot;bin_widths&quot;</span>       <span class="p">:</span> <span class="s2">&quot;Bin widths in which to bin the observed visibilities [\\lambda], list of float or int&quot;</span><span class="p">,</span>
    <span class="nt">&quot;iter_plot_range&quot;</span>  <span class="p">:</span> <span class="s2">&quot;Range of iterations to be plotted in the diagnostic figure, list of int of the form [start, stop]&quot;</span>
  <span class="p">},</span>

  <span class="nt">&quot;analysis&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;bootstrap_ntrials&quot;</span><span class="p">:</span> <span class="s2">&quot;Number of trials (dataset realizations) to perform in a bootstrap analysis&quot;</span><span class="p">,</span>
    <span class="nt">&quot;bootstrap_non_negative&quot;</span> <span class="p">:</span> <span class="s2">&quot;Whether the mean (if false) or best fit nonnegative solution in used in the bootstrap&quot;</span>

  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>That’s it! By default frank saves (in <code class="code docutils literal notranslate"><span class="pre">save_dir</span></code>): <br>
- the logged messages printed during the fit as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_fit.log</span></code>, <br>
- the parameter file used in the fit as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_used_pars.json</span></code>, <br>
- the fitted brightness profile as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_profile_fit.txt</span></code>, <br>
- the visibility domain fit as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_vis_fit.npz</span></code>, <br>
- the <code class="code docutils literal notranslate"><span class="pre">sol</span></code> (solution) object (see <a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/docs/_build/html/py_API.html#frank.radial_fitters.FrankFitter">FrankFitter</a>) as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_sol.obj</span></code> and the <code class="code docutils literal notranslate"><span class="pre">iteration_diagnostics</span></code> object (see <a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/docs/_build/html/py_API.html#frank.radial_fitters.FrankFitter">FrankFitter</a>) as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_iteration_diagnostics.obj</span></code>, <br>
- UVTables for the <strong>reprojected</strong> fit and its residuals as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_uv_fit.npz</span></code> and <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_uv_resid.npz</span></code>, <br>
- figures showing the fit and its diagnostics as <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_fit_quick.png</span></code>, <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_fit_full.png</span></code> and <code class="code docutils literal notranslate"><span class="pre">&lt;uvtable_filename&gt;_frank_fit_diag.png</span></code>.</p>
<p>Here’s the full figure frank produces (if <code class="code docutils literal notranslate"><span class="pre">full_plot=True</span></code> in your parameter file) for a fit to the DSHARP continuum observations of the protoplanetary disc
AS 209 (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJ...869L..41A/abstract">Andrews et al. 2018</a>).</p>
<div class="figure align-left" style="width: 700px">
<img alt="_images/AS209_continuum_frank_fit_full.png" src="_images/AS209_continuum_frank_fit_full.png" />
</div>
<p><strong>a)</strong> The fitted frank brightness profile. <br>
<strong>b)</strong> As in (a), on a log scale. The oscillations below <span class="math notranslate nohighlight">\(\approx 10^9\ {\rm Jy\ sr}^{-1}\)</span> indicate the fit’s noise floor. <br>
<strong>c)</strong> The frank profile swept over <span class="math notranslate nohighlight">\(2\pi\)</span>. Note this image is not convolved with any beam. <br>
<strong>d)</strong> The visibility domain fit and the data in 1 and 50 <span class="math notranslate nohighlight">\({\rm k}\lambda\)</span> bins. <br>
<strong>e)</strong> As in (d), zooming on the longer baselines. <br>
<strong>f)</strong> Residuals between the binned data and the fit. The residuals’ RMSE is given in the legend;
note this is being increased by the residuals beyond the baseline at which the fit walks off the data. <br>
<strong>g)</strong> As in (d), on a log scale. The positive and negative data and fit regions are distinguished since this is a log scale.
On this scale it is more apparent that frank walks off the visibilities as their binned noise begins to grow strongly at <span class="math notranslate nohighlight">\(\approx 4\ {\rm M}\lambda\)</span>. <br>
<strong>h)</strong> The fit’s reconstructed power spectrum, the prior on the fitted brightness profile.
To see how this the fit to this dataset is sensitive to the prior, check out <a class="reference internal" href="tutorials/prior_sensitivity_and_uncertainty.html"><span class="doc">this notebook</span></a>. <br>
<strong>i)</strong> The (binned) imaginary component of the visibilities. frank only fits the real component, so if Im(V) is large,
it could indicate azimuthal asymmetry in the disc that frank will average over.</p>
<div class="section" id="test-a-fit-s-convergence">
<h3>Test a fit’s convergence<a class="headerlink" href="#test-a-fit-s-convergence" title="Permalink to this headline">¶</a></h3>
<p>Once the fit has been performed, it’s important to check its convergence. If <code class="code docutils literal notranslate"><span class="pre">diag_plot=True</span></code> (the default) in the parameter file, frank produces a diagnostic figure to assess this.  Using the fit from the above figure, the diagnostic plot looks like this,</p>
<div class="figure align-left" style="width: 700px">
<img alt="_images/AS209_continuum_frank_fit_diag.png" src="_images/AS209_continuum_frank_fit_diag.png" />
</div>
<p><strong>a)</strong> The fitted frank brightness profile over all fit iterations.
Note how small amplitude, fast oscillations (‘ringing’) that are due to unconstrained
baselines are damped over the first <span class="math notranslate nohighlight">\(\approx 300\)</span> iterations.
The fit runs until a convergence criterion on the power spectrum is met at every collocation point,
<span class="math notranslate nohighlight">\(|(P_{\rm i} - P_{\rm i-1}| &lt;= {\rm tol} * \pi\)</span>,
where <span class="math notranslate nohighlight">\(P_{\rm i}\)</span> is the power spectrum at iteration <span class="math notranslate nohighlight">\(i\)</span>
and <span class="math notranslate nohighlight">\({\rm tol}\)</span> is the tolerance (<code class="code docutils literal notranslate"><span class="pre">iter_tol</span></code>) in your parameter file.
This criterion is more robust than one based on the brightness profile because of the oscillations imposed on the latter by the visibilities’ sparse sampling.
If this stopping condition is not met, the fit runs until <code class="code docutils literal notranslate"><span class="pre">max_iter</span></code> as set in your parameter file. <br>
<strong>b)</strong> Sequential difference between the last 100 brightness profile iterations.
Note the y-scale here is <span class="math notranslate nohighlight">\(10^5\ {\rm Jy\ sr}^{-1}\)</span>, as opposed to <span class="math notranslate nohighlight">\(10^{10}\ {\rm Jy\ sr}^{-1}\)</span> in (a).
So in this case the oscillations remaining at the end of the fit (<span class="math notranslate nohighlight">\(\approx 1250\)</span> iterations) are at a part in <span class="math notranslate nohighlight">\(10^6\)</span>.
<br>
<strong>c)</strong> The reconstructed power spectrum over all fit iterations.
Our initial guess for the power spectrum, a power law with slope of -2, is apparent in the longest baselines for the first <span class="math notranslate nohighlight">\(\approx 250\)</span> iterations,
and then we continue iterating to suppress the high power placed at the data’s noisiest, longest baselines. <br>
<strong>d)</strong> Sequential difference between the last 100 brightness profile iterations.
Note the y-scale here is small compared to (b),
and the largest variation is at the baseline where the fit walks off the visibilities. <br>
<strong>e)</strong> A simple metric for the brightness profile’s convergence, <span class="math notranslate nohighlight">\({\rm max}(|(I_{\rm i} - I_{\rm i-1}|)\ /\ {\rm max}(I_i)\)</span>,
where <span class="math notranslate nohighlight">\(I_i\)</span> is the brightness profile at iteration <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\({\rm max}\)</span> entails the largest value across all collocation points.
In this case the largest variation across all collocation points at the last iteration is thus at a part in <span class="math notranslate nohighlight">\(10^6\)</span> of the profile’s peak brightness, consistent with (b).
We want to ensure this convergence metric isn’t going start increasing again if we iterate for longer, so we wouldn’t have wanted to stop at iteration <span class="math notranslate nohighlight">\(\approx 750\)</span>,
while by iteration <span class="math notranslate nohighlight">\(\approx 1000\)</span> the trend looks good. frank’s internal stopping criterion for the fit, as described above in (a), is not yet met at
iteration 1000, as that criterion is conservative to help ensure the power spectrum (and thus the brightness profile) is no longer appreciably changing.</p>
</div>
<div class="section" id="perform-multiple-fits-in-a-loop">
<h3>Perform multiple fits in a loop<a class="headerlink" href="#perform-multiple-fits-in-a-loop" title="Permalink to this headline">¶</a></h3>
<p>You can run multiple fits in a single call to frank (e.g., to check a fit’s sensitivity to hyperpriors or run a self-consistent analysis on multiple sources)
by setting one or more of the parameters in the parameter file as a list.
See <a class="reference external" href="tutorials/running_fits_in_a_loop.ipynb">this tutorial</a> for an example.</p>
</div>
<div class="section" id="modify-the-fit-py-script">
<h3>Modify the <code class="code docutils literal notranslate"><span class="pre">fit.py</span></code> script<a class="headerlink" href="#modify-the-fit-py-script" title="Permalink to this headline">¶</a></h3>
<p>We’ve run this example using <code class="code docutils literal notranslate"><span class="pre">frank/fit.py</span></code>; if you’d like to modify this file, you can get it <a class="reference external" href="https://raw.githubusercontent.com/discsim/frank/master/frank/fit.py">here</a>.
For an ‘under the hood’ look at what this script does, see <a class="reference internal" href="tutorials/using_frank_as_a_module.html"><span class="doc">this tutorial</span></a>.
If you’d like a video demonstration of how to run the script (with sound), see <a class="reference external" href="https://www.youtube.com/watch?v=xMxsLKQidY4&amp;t=5">here</a>.</p>
</div>
</div>
<div class="section" id="perform-a-fit-using-frank-as-a-python-module">
<h2>Perform a fit using <code class="code docutils literal notranslate"><span class="pre">frank</span></code> as a Python module<a class="headerlink" href="#perform-a-fit-using-frank-as-a-python-module" title="Permalink to this headline">¶</a></h2>
<p>To interface with the code more directly, you can use it as a module.
The wrapper functions in <code class="docutils literal notranslate"><span class="pre">fit.py</span></code> can do everything we’ll show below for us,
but  we’re going to mostly avoid those here,
just to show how to directly interface with the code’s internal classes.</p>
<p>First import some basic stuff from frank and load the data
(again using the DSHARP observations of AS 209, available as a UVTable
<a class="reference external" href="https://github.com/discsim/frank/blob/master/tutorials/AS209_continuum.npz">here</a>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">frank.radial_fitters</span> <span class="kn">import</span> <span class="n">FrankFitter</span>
<span class="kn">from</span> <span class="nn">frank.geometry</span> <span class="kn">import</span> <span class="n">FitGeometryGaussian</span>
<span class="kn">from</span> <span class="nn">frank.fit</span> <span class="kn">import</span> <span class="n">load_data</span>
<span class="kn">from</span> <span class="nn">frank.make_figs</span> <span class="kn">import</span> <span class="n">frank_plotting_style</span><span class="p">,</span> <span class="n">make_quick_fig</span>
<span class="kn">from</span> <span class="nn">frank.io</span> <span class="kn">import</span> <span class="n">save_fit</span>

<span class="n">save_prefix</span> <span class="o">=</span> <span class="s1">&#39;AS209_continuum&#39;</span>
<span class="n">uvtable_filename</span> <span class="o">=</span> <span class="n">save_prefix</span> <span class="o">+</span> <span class="s1">&#39;.npz&#39;</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">uvtable_filename</span><span class="p">)</span>
</pre></div>
</div>
<p>Now run the fit using the <a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/docs/_build/html/py_API.html#frank.radial_fitters.FrankFitter">FrankFitter</a> class.
In this example we’ll ask frank to fit for the disc’s geometry using the <a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/docs/_build/html/py_API.html#frank.geometry.FitGeometryGaussian">FitGeometryGaussian</a> class.
<a class="reference external" href="https://github.com/discsim/frank/blob/master/frank/docs/_build/html/py_API.html#frank.radial_fitters.FrankFitter">FrankFitter</a> will then deproject the visibilities
and fit for the brightness profile. We’ll fit out to 1.6” using 250 collocation points and the code’s default <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">weights_smooth</span></code> hyperprior values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FF</span> <span class="o">=</span> <span class="n">FrankFitter</span><span class="p">(</span><span class="n">Rmax</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">FitGeometryGaussian</span><span class="p">(),</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">weights_smooth</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="n">sol</span> <span class="o">=</span> <span class="n">FF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</pre></div>
</div>
<p>Ok now make a simplified figure showing the fit (with only subplots (a), (b), (d), (f) from the figure above;
when running from the terminal, frank produces this figure if <code class="code docutils literal notranslate"><span class="pre">quick_plot=True</span></code> in your parameter file).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">make_quick_fig</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">bin_widths</span><span class="o">=</span><span class="p">[</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">5e4</span><span class="p">],</span> <span class="n">force_style</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_prefix</span> <span class="o">+</span> <span class="s1">&#39;_frank_fit_quick.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>which makes this,</p>
<div class="figure align-left" style="width: 700px">
<img alt="_images/AS209_continuum_frank_fit_quick.png" src="_images/AS209_continuum_frank_fit_quick.png" />
</div>
<p>Finally we’ll save the fit results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">save_fit</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">save_prefix</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorials.html" class="btn btn-neutral float-right" title="Tutorials" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2020, R. Booth, J. Jennings, M. Tazzari.
      <span class="lastupdated">
        Last updated on 2020 Apr 24 at 17:25:18 UTC // Images: Universal Studios, NBCUniversal [Public domain].
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>